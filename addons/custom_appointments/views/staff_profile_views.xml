<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Staff Profile Form View (Limited fields for staff to edit) -->
    <record id="staff_profile_form_view" model="ir.ui.view">
        <field name="name">custom.staff.member.profile.form</field>
        <field name="model">custom.staff.member</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <form string="My Profile" create="false" delete="false">
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                        <field name="specialization" placeholder="Your specialization/role..."/>
                    </div>
                    
                    <group>
                        <group string="Contact Information">
                            <field name="email" readonly="1"/>
                            <field name="phone"/>
                            <field name="branch_id" readonly="1"/>
                        </group>
                        <group string="Booking Status">
                            <field name="is_bookable" widget="boolean_toggle"/>
                            <field name="image" widget="image" class="oe_avatar"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Availability" name="availability">
                            <group>
                                <group string="Working Days">
                                    <field name="monday_available"/>
                                    <field name="tuesday_available"/>
                                    <field name="wednesday_available"/>
                                    <field name="thursday_available"/>
                                    <field name="friday_available"/>
                                    <field name="saturday_available"/>
                                    <field name="sunday_available"/>
                                </group>
                                <group string="Working Hours">
                                    <field name="start_time" widget="float_time"/>
                                    <field name="end_time" widget="float_time"/>
                                </group>
                            </group>
                        </page>
                        <page string="My Statistics" name="stats">
                            <group>
                                <group string="Appointment Statistics">
                                    <field name="appointment_count" readonly="1"/>
                                    <field name="confirmed_appointment_count" readonly="1"/>
                                    <field name="completed_appointment_count" readonly="1"/>
                                    <field name="this_month_appointments" readonly="1"/>
                                </group>
                            </group>
                            <div class="mt-3">
                                <button name="action_view_appointments" type="object" 
                                        string="View My Appointments" class="btn-primary"
                                        icon="fa-calendar"/>
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Server Action to open current user's staff profile -->
    <record id="action_open_my_profile" model="ir.actions.server">
        <field name="name">Open My Profile</field>
        <field name="model_id" ref="model_custom_staff_member"/>
        <field name="state">code</field>
        <field name="code">
staff = env['custom.staff.member'].sudo().search([
    '|', '|',
    ('user_id', '=', env.user.id),
    ('employee_id.user_id', '=', env.user.id),
    ('email', '=', env.user.email)
], limit=1)

if staff:
    action = {
        'type': 'ir.actions.act_window',
        'name': 'My Profile',
        'res_model': 'custom.staff.member',
        'view_mode': 'form',
        'res_id': staff.id,
        'view_id': env.ref('custom_appointments.staff_profile_form_view').id,
        'target': 'current',
    }
else:
    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'Profile Not Found',
            'message': 'No staff profile found for your account. Please contact your administrator.',
            'type': 'warning',
            'sticky': False,
        }
    }
        </field>
    </record>

    <!-- Menu Item for My Profile -->
    <menuitem id="menu_my_profile"
              name="My Profile"
              parent="appointments_main_menu"
              action="action_open_my_profile"
              sequence="15"/>

</odoo>
