<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Module Category for Appointments -->
    <record id="module_category_appointments" model="ir.module.category">
        <field name="name">Appointments</field>
        <field name="description">Appointment booking and management</field>
        <field name="sequence">20</field>
    </record>

    <!-- ===================== SECURITY GROUPS ===================== -->
    
    <!-- Staff Group - Basic access (own appointments, own profile) -->
    <record id="group_appointment_staff" model="res.groups">
        <field name="name">Staff</field>
        <field name="category_id" ref="module_category_appointments"/>
        <field name="comment">Can view own appointments and edit own profile/availability</field>
    </record>

    <!-- Supervisor Group - Branch-level access -->
    <record id="group_appointment_supervisor" model="res.groups">
        <field name="name">Supervisor</field>
        <field name="category_id" ref="module_category_appointments"/>
        <field name="implied_ids" eval="[(4, ref('group_appointment_staff'))]"/>
        <field name="comment">Can manage appointments and staff within their branch</field>
    </record>

    <!-- Manager Group - Full access -->
    <record id="group_appointment_manager" model="res.groups">
        <field name="name">Manager</field>
        <field name="category_id" ref="module_category_appointments"/>
        <field name="implied_ids" eval="[(4, ref('group_appointment_supervisor'))]"/>
        <field name="comment">Full access to all appointment features, settings, and configuration</field>
    </record>

    <!-- ===================== RECORD RULES ===================== -->

    <!-- ===== APPOINTMENT RECORD RULES ===== -->
    
    <!-- Staff: Can only see appointments where they are the assigned staff member (by user_id match) -->
    <record id="appointment_rule_staff" model="ir.rule">
        <field name="name">Appointments: Staff sees own appointments</field>
        <field name="model_id" ref="model_custom_appointment"/>
        <field name="domain_force">['|', '|',
            ('staff_member_id.user_id', '=', user.id),
            ('staff_member_id.employee_id.user_id', '=', user.id),
            ('user_id', '=', user.id)
        ]</field>
        <field name="groups" eval="[(4, ref('group_appointment_staff'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Supervisor: Can see appointments for staff in their branch -->
    <record id="appointment_rule_supervisor" model="ir.rule">
        <field name="name">Appointments: Supervisor sees branch appointments</field>
        <field name="model_id" ref="model_custom_appointment"/>
        <field name="domain_force">[('staff_member_id.branch_id.id', 'in', user.env['custom.staff.member'].sudo().search([('user_id', '=', user.id)]).mapped('branch_id').ids)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_supervisor'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Manager: Full access to all appointments -->
    <record id="appointment_rule_manager" model="ir.rule">
        <field name="name">Appointments: Manager has full access</field>
        <field name="model_id" ref="model_custom_appointment"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_manager'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- ===== STAFF MEMBER RECORD RULES ===== -->
    
    <!-- Staff: Can only see/edit their own staff record -->
    <record id="staff_member_rule_staff" model="ir.rule">
        <field name="name">Staff Member: Staff sees own record</field>
        <field name="model_id" ref="model_custom_staff_member"/>
        <field name="domain_force">['|', ('user_id', '=', user.id), ('employee_id.user_id', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_staff'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Supervisor: Can see staff in their branch -->
    <record id="staff_member_rule_supervisor" model="ir.rule">
        <field name="name">Staff Member: Supervisor sees branch staff</field>
        <field name="model_id" ref="model_custom_staff_member"/>
        <field name="domain_force">[('branch_id.id', 'in', user.env['custom.staff.member'].sudo().search([('user_id', '=', user.id)]).mapped('branch_id').ids)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_supervisor'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Manager: Full access to all staff members -->
    <record id="staff_member_rule_manager" model="ir.rule">
        <field name="name">Staff Member: Manager has full access</field>
        <field name="model_id" ref="model_custom_staff_member"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_manager'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- ===== BRANCH RECORD RULES ===== -->
    
    <!-- Staff: Can read branches (needed for display) -->
    <record id="branch_rule_staff" model="ir.rule">
        <field name="name">Branch: Staff can read all branches</field>
        <field name="model_id" ref="model_custom_branch"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_staff'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Manager: Full access to branches -->
    <record id="branch_rule_manager" model="ir.rule">
        <field name="name">Branch: Manager has full access</field>
        <field name="model_id" ref="model_custom_branch"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_manager'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- ===== SERVICE RECORD RULES ===== -->
    
    <!-- Staff: Can read services (needed for display) -->
    <record id="service_rule_staff" model="ir.rule">
        <field name="name">Service: Staff can read all services</field>
        <field name="model_id" ref="model_company_service"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_staff'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Manager: Full access to services -->
    <record id="service_rule_manager" model="ir.rule">
        <field name="name">Service: Manager has full access</field>
        <field name="model_id" ref="model_company_service"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_manager'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- ===== SETTINGS RECORD RULES ===== -->
    
    <!-- Manager only: Settings access -->
    <record id="settings_rule_manager" model="ir.rule">
        <field name="name">Settings: Manager has full access</field>
        <field name="model_id" ref="model_custom_appointment_settings"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_manager'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- ===== PROMO CODE RECORD RULES ===== -->
    
    <!-- Manager only: Promo code access -->
    <record id="promo_rule_manager" model="ir.rule">
        <field name="name">Promo Code: Manager has full access</field>
        <field name="model_id" ref="model_custom_appointment_promo"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_appointment_manager'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

</odoo>
